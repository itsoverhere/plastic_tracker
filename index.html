<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>

	<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
	<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-auth-compat.js"></script>

	<script src="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.js"></script>
	<link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.0/firebase-ui-auth.css" />

	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

	<link rel="stylesheet" href="css/style.css" />
	<script src="js/index.var.js"></script>

</head>

<body>

	<div id="firebaseui-auth-container" class="focused"></div>


	<script>
		let app, auth
		let currentUser
		let uiConfig

		function setupFirebase() {
			return new Promise((resolve) => {
				const firebaseConfig = {
					apiKey: "AIzaSyBx-vcALRbrfXRGpyMwZHGgTH_0mgQI_xk",
					//					authDomain: "plastic-tracker-2cbb7.firebaseapp.com",
					authDomain: "itsoverhere.github.io",
					projectId: "plastic-tracker-2cbb7",
					storageBucket: "plastic-tracker-2cbb7.appspot.com",
					appId: "1:645843325306:web:5f4b90dc9388fe16f4c6c3",
					measurementId: "G-2FF14XFMB6"
				};
				app = firebase.initializeApp(firebaseConfig);

				uiConfig = {
					signInSuccessUrl: 'index.html',
					signInOptions: [
						// Leave the lines as is for the providers you want to offer your users.
						firebase.auth.GoogleAuthProvider.PROVIDER_ID,
						firebase.auth.EmailAuthProvider.PROVIDER_ID,
					],
					callbacks: {
						signInSuccessWithAuthResult: function(authResult, redirectUrl) {
							// Process result. This will not trigger on merge conflicts.
							// On success redirect to signInSuccessUrl.
							console.log("log in success")
							return true;
						},

						signInFailure: function(errorl) {
							// Process result. This will not trigger on merge conflicts.
							// On success redirect to signInSuccessUrl.
							console.log("log in failed")
						}
					}
				}
				resolve()
			})
		}


		function authenticate() {
			return new Promise((resolve) => {
				auth = firebase.auth()

				auth.onAuthStateChanged(function(user) {
					if (user) {
						// User is signed in.
						var displayName = user.displayName;
						var email = user.email;
						var emailVerified = user.emailVerified;
						var photoURL = user.photoURL;
						var uid = user.uid;
						var phoneNumber = user.phoneNumber;
						var providerData = user.providerData;
						user.getIdToken().then(function(accessToken) {
							document.getElementById('sign_in').textContent = 'Sign out';

							currentUser = {
								displayName: displayName,
								email: email,
								emailVerified: emailVerified,
								phoneNumber: phoneNumber,
								photoURL: photoURL,
								uid: uid,
								accessToken: accessToken,
								providerData: providerData
							}
							hideAuthModal()
							resolve()
						});

					} else {
						//						document.getElementById('sign_in').textContent = 'Sign in';
						// Initialize the FirebaseUI Widget using Firebase.
						var ui = new firebaseui.auth.AuthUI(auth);
						// The start method will wait until the DOM is loaded.
						ui.start('#firebaseui-auth-container', uiConfig);
					}
				}, function(error) {
					console.log(error);
				});
			})
		}


		window.addEventListener('load', function() {
			initApp()
		});

		initApp = function() {
			Promise.resolve()
				.then(setupFirebase)
				//				.then(authenticate)
				.then(() => {
					console.log("setup done")

					firebase.auth().onAuthStateChanged(function(user) {
						if (user) {
							// User is signed in.
							var displayName = user.displayName;
							var email = user.email;
							var emailVerified = user.emailVerified;
							var photoURL = user.photoURL;
							var uid = user.uid;
							var phoneNumber = user.phoneNumber;
							var providerData = user.providerData;
							user.getIdToken().then(function(accessToken) {
								//								document.getElementById('sign_in').textContent = 'Sign out';

								currentUser = {
										displayName: displayName,
										email: email,
										emailVerified: emailVerified,
										phoneNumber: phoneNumber,
										photoURL: photoURL,
										uid: uid,
										accessToken: accessToken,
										providerData: providerData
									}
									//								hideAuthModal()
									//								resolve()
							});

						} else {
							//							document.getElementById('sign_in').textContent = 'Sign in';
							//							// Initialize the FirebaseUI Widget using Firebase.
							//							var ui = new firebaseui.auth.AuthUI(auth);
							//							// The start method will wait until the DOM is loaded.
							//							ui.start('#firebaseui-auth-container', uiConfig);
							var provider = new firebase.auth.GoogleAuthProvider();
							firebase.auth()
								.signInWithPopup(provider)
								.then((result) => {
									/** @type {firebase.auth.OAuthCredential} */
									var credential = result.credential;

									// This gives you a Google Access Token. You can use it to access the Google API.
									var token = credential.accessToken;
									// The signed-in user info.
									var user = result.user;
									// ...
								}).catch((error) => {
									// Handle Errors here.
									var errorCode = error.code;
									var errorMessage = error.message;
									// The email of the user's account used.
									var email = error.email;
									// The firebase.auth.AuthCredential type that was used.
									var credential = error.credential;
									// ...
								});
						}
					}, function(error) {
						console.log(error);
					});



				})
		};

	</script>

	<script>
		$(document).ready(function() {
			$("div#sign_in").click(() => {
				if (currentUser) {
					auth.signOut().then(() => {
						location.reload()
					}).catch((error) => {
						console.log("Error in signing out")
					})
				}
			})
		})

	</script>
</body>

</html>
